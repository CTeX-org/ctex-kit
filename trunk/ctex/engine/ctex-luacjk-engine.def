% ctex-luacjk-engine.def: for LuaTeX engine with luatexja
% vim:ft=tex

% compatibility with amssymb.sty etc and xunicode.sty v0.95+
\def\CTEX@save@symlist{hbar,Finv,aleph,beth,gimel,daleth,Game}

\@for \reserved@a:=\CTEX@save@symlist \do{%
  \csletcs{CTEX@save@\reserved@a}{\reserved@a}}

\RequirePackage{fontspec}[2011/09/13]
\RequirePackage{luatexja}

\@for \reserved@a:=\CTEX@save@symlist \do{%
  \csletcs{UTF\reserved@a}{\reserved@a}
  \csletcs{\reserved@a}{CTEX@save@\reserved@a}
  \ifcsundef{\reserved@a}{\cslet{\reserved@a}\CTEX@undefined}{}
}
\let\CTEX@save@symlist\CTEX@undefined

\ExplSyntaxOn

\defaultfontfeatures{Ligatures=TeX}

\prop_new:N \g_CJK_family_name_prop
\cs_new_nopar:Nn \ctex_CJKfamily_map:n
  {
    \prop_if_in:NnTF \g_CJK_family_name_prop {#1}
      { \prop_get:Nn \g_CJK_family_name_prop {#1} }
      { \k@family }
  }
\cs_generate_variant:Nn \ctex_CJKfamily_map:n { f }
\cs_generate_variant:Nn \prop_get:Nn   { NV }
\cs_generate_variant:Nn \prop_gput:Nnn { Nx }

\tl_set:Nn \CJKrmdefault { rm }
\tl_set:Nn \CJKsfdefault { sf }
\tl_set:Nn \CJKttdefault { tt }
\tl_set:Nn \mcdefault \CJKrmdefault
\tl_set:Nn \gtdefault \CJKsfdefault
\tl_set:Nn \CJKfamilydefault \CJKrmdefault
\tl_set:Nn \kanjifamilydefault { \ctex_CJKfamily_map:f \CJKfamilydefault }
\tl_set:Nn \kanjiencodingdefault { CJKEU2 }

\cs_generate_internal_variant:n { fffff }
\cs_generate_internal_variant:n { ffff }

\DeclareKanjiEncodingDefaults { } { }
\DeclareYokoKanjiEncoding \kanjiencodingdefault { } { }

\cs_new_nopar:Npn \CJKjfmdefault #1 { \tl_set:Nn \l_jfm_default_tl {#1} }
\CJKjfmdefault { quanjiao }

\DeclareKanjiFamily{JY3} {rm} { }
\DeclareFontShape  {JY3} {rm} {m} {n}
  { <-> psft:SimSun:cid=Adobe-GB1-5;jfm=\l_jfm_default_tl } { }
\DeclareKanjiFamily{CJKEU2} {rm} { }
\DeclareFontShape  {CJKEU2} {rm} {m} {n}
  { <-> psft:SimSun:cid=Adobe-GB1-5;jfm=\l_jfm_default_tl } { }

\cs_gset_protected_nopar:cpn { CJKfamily/\CJKfamilydefault }
  { \tl_gset:cn { CJKfamily/\CJKfamilydefault } { rm } }

\kanjiencoding { \kanjiencodingdefault }
\kanjifamily   { rm }

\tl_put_left:Nn \document
  {
    \group_end:
    \CJKfamily { \CJKfamilydefault }
    \normalfont
    \exp_args:Nfffff \DeclareErrorKanjiFont
      \kanjiencodingdefault \kanjifamilydefault
      \kanjiseriesdefault   \kanjishapedefault  \f@size
    \cs_undefine:c { T @ \kanjiencodingdefault }
    \DeclareYokoKanjiEncoding \kanjiencodingdefault { } { }
    \exp_args:Nffff \DeclareKanjiSubstitution
      \kanjiencodingdefault \kanjifamilydefault
      \kanjiseriesdefault   \kanjishapedefault
    \DeclareSymbolFont{mrm}
      \kanjiencodingdefault \kanjifamilydefault
      \kanjiseriesdefault   \kanjishapedefault
    \SetSymbolFont{mrm}{bold}
      \kanjiencodingdefault \kanjifamilydefault
      \bfdefault            \kanjishapedefault
    \jfam\symmrm
    \group_begin:
  }

\AtBeginDocument
  {
    \etex_protected:D \tl_put_right:Nn \rmfamily { \CJKfamily \CJKrmdefault }
    \etex_protected:D \tl_put_right:Nn \sffamily { \CJKfamily \CJKsfdefault }
    \etex_protected:D \tl_put_right:Nn \ttfamily { \CJKfamily \CJKttdefault }
  }

\keys_define:nn { fontspec }
  {
    CID     .meta:n = { RawFeature = {    cid = #1 } } ,
    JFM     .meta:n = { RawFeature = {    jfm = #1 } } ,
    JFM-var .meta:n = { RawFeature = { jfmvar = #1 } } ,
    CID     .value_required: ,
    JFM     .value_required: ,
    JFM-var .value_required: ,
  }

\keys_define:nn { fontspec-preparse-external }
  { NoEmbed .code:n = { \cs_gset:Nn \fontspec_namewrap:n { psft: ##1 } } }

\cs_set:Nn \fontspec_fullname:n
  {
    \tl_if_head_eq_charcode:fNTF {#1} [ % ]
      {#1} { \fontspec_namewrap:n { #1 \l_fontspec_extension_tl } }
    \l_fontspec_renderer_tl
    \l_fontspec_optical_size_tl
  }

\cs_new_nopar:Nn \ctex_fontspec_select:nn
  {
    \group_begin:
    \tl_set_eq:NN \g_fontspec_encoding_tl \kanjiencodingdefault
    \cs_set_eq:NN \DeclareFontFamily      \DeclareKanjiFamily
    \tl_if_in:nnF {#1} { JFM }
      { \tl_put_right:Nn \g_CJK_default_fontopts_tl { JFM=\l_jfm_default_tl , } }
    \tl_set_eq:NN \g_fontspec_default_fontopts_tl \g_CJK_default_fontopts_tl
    \fontspec_select:nn {#1} {#2}
    \group_end:
  }

\cs_new_nopar:Nn \ctex_set_family:Nnn
  {
    \ctex_fontspec_select:nn {#2} {#3}
    \tl_set_eq:NN #1 \l_fontspec_family_tl
  }

\cs_new_nopar:Nn \ctex_new_family:nnn
  {
    \cs_gset_protected_nopar:cpx { CJKfamily/#1 }
      {
        \exp_not:N \ctex_fontspec_select:nn {#2} {#3}
        \exp_not:n { \prop_gput:NnV \g_CJK_family_name_prop } {#1}
        \exp_not:N \l_fontspec_family_tl
        \exp_not:N \tl_gset_eq:cN { CJKfamily/#1 }
        \exp_not:N \l_fontspec_family_tl
      }
  }

\NewDocumentCommand \CJKfamily { m }
  {
    \prop_if_in:NxF \g_CJK_family_name_prop {#1}
      {
        \cs_if_exist_use:cF { CJKfamily/#1 }
          {
            \cs_if_free:cT { ctex_warned_aux_#1 }
              {
                \msg_warning:nnx { ctex } { CJKfamily-Unknown } {#1}
                \tl_new:c { ctex_warned_aux_#1 }
              }
            \use_none:nnnnnnn
          }
      }
    \tl_set:Nx \l_CJK_family_tl {#1}
    \exp_args:Nc \kanjifamily { CJKfamily/\l_CJK_family_tl }
    \selectfont
  }

\cs_generate_variant:Nn \prop_if_in:NnF  { Nx }

\msg_new:nnn { ctex } { CJKfamily-Unknown }
  {
    Unknown~CJK~family~'#1'~is~ignored.\\\\
    Try~to~use~\token_to_str:N \setCJKfamilyfont{#1}[...]{...}\c_space_tl
    to~define~it.
  }

\NewDocumentCommand \CJKfontspec { O{} m }
  {
    \ctex_set_family:Nnn \k@family {#1} {#2}
    \selectfont
    \tex_ignorespaces:D
  }

\NewDocumentCommand \setCJKfamilyfont { m O{} m }
  { \ctex_new_family:nnn {#1} {#2} {#3} }
\NewDocumentCommand \setCJKmainfont { O{} m }
  { \ctex_new_family:nnn \CJKrmdefault {#1} {#2} }
\cs_new_eq:NN \setCJKromanfont \setCJKmainfont
\NewDocumentCommand \setCJKsansfont { O{} m }
  { \ctex_new_family:nnn \CJKsfdefault {#1} {#2} }
\NewDocumentCommand \setCJKmonofont { O{} m }
  { \ctex_new_family:nnn \CJKttdefault {#1} {#2} }
\NewDocumentCommand \newCJKfontfamily { o m O{} m }
  {
    \tl_set:Nx \l_ctex_family_name_tl
      { \IfNoValueTF {#1} { \cs_to_str:N #2 } {#1} }
    \ctex_new_family:nnn \l_ctex_family_name_tl {#3} {#4}
    \cs_new_protected_nopar:Npx #2
      { \exp_not:N \CJKfamily { \l_ctex_family_name_tl } }
  }

\tl_new:N \g_CJK_default_fontopts_tl
\NewDocumentCommand \defaultCJKfontfeatures { m }
  { \tl_set:Nn \g_CJK_default_fontopts_tl { #1 , } }

\@onlypreamble\setCJKmainfont
\@onlypreamble\setCJKsansfont
\@onlypreamble\setCJKmonofont
\@onlypreamble\setCJKromanfont
\@onlypreamble\defaultCJKfontfeatures

\NewDocumentCommand \addCJKfontfeatures { m }
  {
    \cs_if_free:cTF { zf@family@fontdef\k@family }
      { \fontspec_warning:n { addfontfeatures-ignored } }
      {
        \exp_args:Nxx \ctex_fontspec_select:nn
          { \clist_use:c { zf@family@options\k@family } , #1 }
          { \tl_use:c { zf@family@fontname\k@family } }
        \kanjifamily \l_fontspec_family_tl \selectfont
      }
    \tex_ignorespaces:D
  }

\cs_set_eq:NN \addCJKfontfeature \addCJKfontfeatures

\tl_gset:cn { ver@CJK.sty } { 2020/01/01 }

\cs_new_nopar:Npn \CJKglue { \skip_horizontal:n { \ltjgetparameter { kanjiskip } } }
\cs_new_nopar:Npn \CJKglueamount   #1 { \ltjsetparameter {  kanjiskip = {#1} } }
\cs_new_nopar:Npn \CJKecglueamount #1 { \ltjsetparameter { xkanjiskip = {#1} } }
\cs_new_nopar:Npn \CJKspace   { \ltjsetparameter { autospacing = false } }
\cs_new_nopar:Npn \CJKnospace { \ltjsetparameter { autospacing = true } }

\cs_new_eq:NN \punctstyle \CJKjfmdefault

\ifCTEX@punct
  \punctstyle { quanjiao }
\else
  \punctstyle { plain }
\fi

\ExplSyntaxOff
\endinput
