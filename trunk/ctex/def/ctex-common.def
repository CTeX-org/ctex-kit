% ctex-common.def: common definitions for all ctex packages/classes
% vim:ft=tex

\@ifclassloaded{article}{\def\CTEX@class{article}}{}
\@ifclassloaded{report} {\def\CTEX@class{report}}{}
\@ifclassloaded{book}   {\def\CTEX@class{book}}{}

% Load some extra packages

\RequirePackage{ifpdf}
\RequirePackage{ifxetex}

\ifxetex % XeTeX always uses UTF-8 as default encoding
  \CTEX@set@opt{encoding=UTF8,engine=xeCJK}
  \let\CTEX@strcmp\strcmp
\else
  \let\CTEX@strcmp\pdfstrcmp
\fi

\RequirePackage[encoding=\CTEX@encoding]{zhnumber}

\ifCTEX@indent
  \RequirePackage{indentfirst}
\fi
\RequirePackage{fix-cm}
\ifCTEX@fancyhdr
  \RequirePackage{fancyhdr}
\fi

% Useful definitions

\DeclareRobustCommand\CTeX{C\kern-.05em\TeX{}}
\newcommand*\CTEX@key{\define@key{CTEX}}
\newcommand*\CTEXoptions[1][]{\kvsetkeys{CTEX}{#1}}
\newcommand*\CTEX@subkey[1]{\define@key{CTEX#1}}
\newcommand*\CTEXsetup[2][]{\kvsetkeys{CTEX#2}{#1}}

\def\CTEX@IfStrEq#1#2{%
  \ifnum\CTEX@strcmp{#1}{#2}=\z@
    \expandafter\@firstoftwo
  \else
    \expandafter\@secondoftwo
  \fi}

\def\ifCTEX@encoding#1{\CTEX@IfStrEq\CTEX@encoding{#1}}
\def\ifCTEX@engine  #1{\CTEX@IfStrEq\CTEX@engine  {#1}}
\def\ifCTEX@fontset #1{\CTEX@IfStrEq\CTEX@fontset {#1}}
\def\ifCTEX@cls     #1{\CTEX@IfStrEq\CTEX@class   {#1}}

\def\CTEX@replacecommand#1#2#3{%
  \csletcs{#1#3}{#2#3}%
  \csdef{#2#3}{\csuse{#1#3}}}

% Select engine: xetex has the highest priority, if not,
% then try cct, otherwise we use traditional cjk.

\ifCTEX@engine{CCT}{
  \CTEX@set@opt{encoding=GBK}
  \input{ctex-cct-engine.def}
}{
  \ifCTEX@engine{xeCJK}
    {\input{ctex-xecjk-engine.def}}
    {\input{ctex-cjk-engine.def}}
  \input{ctex-cjk-common.def}
}

\AtEndOfPackage{%
  \makeatletter
  \ifCTEX@encoding{GBK}
    {\input{ctex-gbk.def}}
    {\input{ctex-utf8.def}}
  \makeatother}

\newcommand*\CTEXindent{\CTEXsetfont\parindent2\ccwd}
\newcommand*\CTEXnoindent{\parindent\z@}
\ifCTEX@indent
  \AtBeginDocument{\CTEXindent}
\fi
\def\CTEX@spaceChar{\hskip \f@size \p@}
\def\baselinestretch{1.3}

% About numbers

\zhnumsetup{% Is it necessary?
   -    = \CTEX@minus ,
   -0   = \CTEX@null  ,
   0    = \CTEX@zero  ,
   1    = \CTEX@one   ,
   2    = \CTEX@two   ,
   3    = \CTEX@three ,
   4    = \CTEX@four  ,
   5    = \CTEX@five  ,
   6    = \CTEX@six   ,
   7    = \CTEX@seven ,
   8    = \CTEX@eight ,
   9    = \CTEX@nine  ,
   10   = \CTEX@ten   ,
   10e2 = \CTEX@hundred ,
   10e3 = \CTEX@thousand ,
   10e4 = \CTEX@tenthousand ,
   10e8 = \CTEX@hundredmillion }

\DeclareRobustCommand*\CTEXnumber[2]{\edef#1{\noexpand\zhnumber{#2}}}
\DeclareRobustCommand*\CTEXdigits[2]{\edef#1{\noexpand\zhdigits{#2}}}

\let\ctexnumber\zhnumber
\let\ctexdigits\zhdigits
\let\chinese\zhnum
\let\Chinese\chinese
\let\CTEXcounter\@gobble

% About caption

\ifCTEX@cap
  \let\CTEX@save@refstepcounter\refstepcounter
  \def\refstepcounter#1{\CTEX@save@refstepcounter{#1}%
    \protected@edef\@currentlabel
      {\csuse{p@#1}%
       \ifcsundef{CTEX@the#1}{\csuse{the#1}}{\csuse{CTEX@the#1}}%
      }}%
\fi

% `today' definitions

\let\CTEX@todayold\today
\def\CTEX@todaysmall{%
  ~\the\year~\CTEX@year~\the\month~\CTEX@month~\the\day~\CTEX@day}
\def\CTEX@todaybig{%
  \ctexdigits{\the\year}\CTEX@year
  \ctexnumber{\the\month}\CTEX@month
  \ctexnumber{\the\day}\CTEX@day}
\ifCTEX@cap
  \renewcommand*\today{\CTEX@todaysmall}
\fi
\CTEX@key{today}{\CTEX@settoday{#1}}
\newcommand*\CTEX@settoday[1]{%
  \ifcsundef{CTEX@today#1}
    {\PackageError{ctex}{%
       unknown today format}{%
       Available today format are "old", "small", and "big".}}
    {\renewcommand*\today{\csuse{CTEX@today#1}}}}

% Put hyperref as bottom as possible, otherwise there may be page
% count issues
\ifCTEX@hyperref
\providecommand\hypersetup[1]{%
  \PassOptionsToPackage{#1}{hyperref}}
\AtEndPreamble{%
  \RequirePackage{hyperref}}
\AtEndOfPackage{%
  \ifCTEX@encoding{GBK}{%
    \unless\ifxetex
      \hypersetup{CJKbookmarks}
      \unless\ifpdf % dvipdfmx
        \AtBeginDvi{\special{pdf:tounicode GBK-EUC-UCS2}}%
      \fi
    \fi
  }{\hypersetup{unicode}}
  \hypersetup{driverfallback=dvipdfmx,colorlinks=true}
}
\fi % hyperref

\endinput
