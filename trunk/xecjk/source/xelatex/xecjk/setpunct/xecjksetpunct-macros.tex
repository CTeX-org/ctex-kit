%%
%% This is file `xecjksetpunct-macros.tex',
%% generated with the docstrip utility.
%%
%% The original source files were:
%%
%% xeCJK.dtx  (with options: `xecjksetpunct-macros')
%% 
%%  Version 2.2.9 (20-Sept-2008)
%% 
%%  Copyright (C) Wenchang Sun <sunwch@hotmail.com>
%% 
%%  This file may be distributed and/or modified under the
%%  conditions of the LaTeX Project Public License, either version 1.3
%%  of this license or (at your option) any later version.
%%  The latest version of this license is in
%%    http://www.latex-project.org/lppl.txt
%%  and version 1.3 or later is part of all distributions of LaTeX
%%  version 2005/12/01 or later.
%% 

\documentclass{article}
\begin{document}
\makeatletter
\pagestyle{empty}
\newcount\cnta
\newcount\cntb
\newcount\cntc

\def\xeCJK@gobble@a[]{}

\def\get@punctchar#1{
  \expandafter\def\csname xeCJK@punctchar@\the\cnta\endcsname{#1}
  \advance\cnta 1\relax
  \@ifnextchar[{\xeCJK@gobble@a}{\get@punctchar}
}

\def\getpunctchar{
  \cnta=0
  \get@punctchar}

\bgroup
\catcode`\%=11
\catcode`\{=11
\catcode`\}=11
\catcode`\(=1
\catcode`\)=2
\catcode`\#=11
\gdef\sharp(#)
\global\def\percent(%)
\global\def\lbrace({)
\global\def\rbrace(})
\egroup

\newwrite\fdrubisha
\newwrite\fdcfg
\newread\fdin

\def\makefile@rubisha{
\immediate\openout\fdrubisha=rubisha.tex\relax
\immediate\write\fdrubisha{\string\documentclass{article}}
\immediate\write\fdrubisha{\string\textwidth 150mm      }
\immediate\write\fdrubisha{\string\textheight 210mm     }
\immediate\write\fdrubisha{\string\begin{document}       }
\immediate\write\fdrubisha{\string\XeTeXuseglyphmetrics=0}
\immediate\write\fdrubisha{\string\makeatletter          }
\immediate\write\fdrubisha{\string\pagestyle{empty}      }
\immediate\write\fdrubisha{\string\def\string\punctlist\sharp1\lbrace
      \sharp1\string\rule{0.5pt}{40pt}\string\newpage}
\immediate\write\fdrubisha{\string\rule{0.5pt}{20pt}\sharp1\string\newpage}
\immediate\write\fdrubisha{\string\@ifnextchar[{\string\xeCJK@gobble@a}{\string\punctlist}\rbrace}
\immediate\write\fdrubisha{}
\immediate\write\fdrubisha{\string\def\string\xeCJK@gobble@a[]{}                       }
\immediate\write\fdrubisha{}
\immediate\write\fdrubisha{\string\font\string\1=\ttfontname\space at 100 pt}
\immediate\write\fdrubisha{\string\1}
\immediate\write\fdrubisha{\string\punctlist\space\puncts []}
\immediate\write\fdrubisha{\string\end{document}}
\immediate\closeout\fdrubisha\relax}

\newcommand{\xeCJKsetfont}[2][]{
  \expandafter\getpunctchar\puncts[]
  \edef\ttfontname{#2}
  \edef\ttfontnamea{#1}
  \makefile@rubisha
  \immediate\write18{xelatex rubisha}
  \immediate\write18{\ghostscript}
  \epstobbox
  }

\catcode`\%=11\relax

\def\getfontname"#1"#2{
  \edef\temp{\zap@space #1 \@empty}
  \edef\temp{\lowercase{\def\noexpand#2{\temp}}}
  \temp}

\def\epstobbox{
  \expandafter\getfontname\ttfontname{\@ttfontname}
  \ifx\ttfontnamea\@empty
  \else
    \expandafter\getfontname\ttfontnamea{\@ttfontnamea}
  \fi

  \cntb=0
  \def\xeCJKspaces{}
  \immediate\openin\fdin=rubishb.tex\relax
  \ifeof\fdin
    \@latex@error{setpunct: file rubishb.tex not found}{}\relax
  \fi
  \loop
    \edef\xeCJKspaces{\xeCJKspaces\csname xeCJK@punctchar@\the\cntb\endcsname,}
    \getxyspace
    \edef\xeCJKspaces{\xeCJKspaces\temp@xspace,}
    \getxyspace
    \edef\xeCJKspaces{\xeCJKspaces\temp@xspace,}
    \advance\cntb 1
  \ifnum\cntb<36\repeat
  \immediate\closein\fdin
  \immediate\write\fdcfg{\string\expandafter\string\def\string\csname\space
    xeCJK@\@ttfontname @spaces\string\endcsname{\xeCJKspaces,,,}\string\relax}
  \ifx\ttfontnamea\@empty
  \else
    \immediate\write\fdcfg{\string\expandafter\string\let\string\csname\space
      xeCJK@\@ttfontnamea @spaces\string\expandafter\string\endcsname
      \string\csname\space xeCJK@\@ttfontname @spaces\string\endcsname}
  \fi}

\def\getxyspace{
  \read\fdin to\tempa
  \edef\:{\tempa}
  \expandafter\getleftupdimen\: {} %%BoundingBox: 1 1 0 0 \relax
  \ifnum\temp@xwidth<0\relax
    \read\fdin to\tempa
    \edef\:{\tempa}
    \expandafter\getleftupdimen\: {} %%BoundingBox: 1 1 0 0 \relax
  \fi
  \ifnum\temp@xwidth<1
    \@latex@error{error in setting punct bbox \tempa}{}\relax
  \fi
  \cnta=-\temp@xwidth\relax
  \advance\cnta 100\relax
  \ifnum\cnta<0
    \cnta=0\relax
  \fi
  \edef\temp@xspace{\the\cnta}}

\long\def\getleftupdimen#1%%BoundingBox: #2 #3 #4 #5 {
  \cnta=#4\relax
  \advance\cnta -#2\relax
  \edef\temp@xwidth{\the\cnta}
  \gobblerest}

\long\def\gobblerest#1\relax{}

\immediate\openout\fdcfg=xeCJKpunct.spa\relax
\immediate\write\fdcfg{% -*- coding: utf-8 -*-}

\xeCJKsetfonts

\immediate\write\fdcfg{\string\endinput}
\immediate\closeout\fdcfg
\end{document}
\endinput
%%
%% End of file `xecjksetpunct-macros.tex'.
