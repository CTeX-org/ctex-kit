\startenvironment doc-env

\usemodule[chart]
\usemodule[t][layout]
\usemodule[bib]

\usetypescriptfile[zhfonts]
\usetypescript[myfont]
\setupbodyfont[myfont,rm,11pt]
\setscript[hanzi]

\setupcolors[state=start]
\setupcolor[hex]
\definecolor[mygreen][h=669933]

\setupinteraction
        [state=start,
         focus=standard,
         color=mygreen,
         title={ConTeXt 学习笔记},
         subtitle={Using MkIV},
         author={Li Yanrui},
         keyword={TeX, ConTeXt, MkIV, LuaTeX}]

\setupinteractionscreen[option=max]

\setuppapersize[A4][A4]
\setuplayout[width=fit,height=middle,
             leftmargin=3cm,rightmargin=3cm,
             backspace=4cm,topspace=2cm,
             headerdistance=.5cm,footerdistance=.5cm,
	    leftmargindistance=.5cm,rightmargindistance=.5cm,
             header=1cm,footer=1cm]
\setuppagenumbering[style=\tfx,location=]

\setuptolerance[horizontal, stretch]

% 图片目录
\setupexternalfigures[directory={./figures}]

%-------- 标题设置 --------
\setupheads[indentnext=yes]

\setuphead[title][style=\bfb,header=empty,foote=empty]
\setuphead[chapter]
          [style=\bfb,header=empty,footer=empty]
\setuphead[section][style=\bfa]
\setuphead[subsubject][style=\bf]

% 代码环境
\setuplinenumbering[color=darkgray,style=small]
\setuptyping[option=color,palet=graypretty,
			 before={\blank[.5em]\setupinterlinespace[medium]},
        	 after={\blank[.5em]}]

\definetyping[niceTEX][option=TEX]

%-------- 中文化 --------
\setuplabeltext [en] [chapter={第\;,\;章}]
\setuplabeltext [en] [figure=图\;]
\setuplabeltext [en] [table=表\;]
\setupheadtext[en][pubs={\bfc 参考文献}]
\setupheadtext[en][content={\bfc 目录}]

%% 目录 %%
\def\ChapterNumber#1{\doiftext{#1}{第\;#1\;章\quad}}
\setuplist
    [chapter]
    [alternative=a,
     before={\page[preference]\blank},
     after=\blank,
     style=\bf,
     width=fit,
     pagestyle=boldslanted,
     pagenumber=no,
     numbercommand=\ChapterNumber]

\def\PageNumber#1{\color[darkgray]{#1}.}
\setuplist
    [section]
    [alternative=d,
     style=normal,
     pagecommand=\PageNumber,
     pagestyle=\itx]

% 页眉页脚
\startsetups HeaderFooter
        \def\CurrentChapter{%
                第 \headnumber[chapter]\ 章%
                \hbox to 2em{}%
                \getmarking[chapter]%
                }
        \def\CurrentSection{%
                \headnumber[section]%
                \hbox to 2em{}%
                \getmarking[section]%
                }
        \setupheadertexts
                [\CurrentChapter][pagenumber]
                [pagenumber][\CurrentSection]
        \setupfootertexts[{\ConTeXt\ 学习笔记}][{\goto{\bfx 目录}[Content]}]
                [{\goto{\bfx 目录}[Content]}][{\ConTeXt\ 学习笔记}]
        \setupheader[style=\bfx,color=darkgray]
        \setupfooter[style=\bfx,color=darkgray]
\stopsetups

% 书签
\setupinteractionscreen[option=bookmark]
\placebookmarks[chapter,section][chapter]

% 参考文献
\setupbibtex[database=bibliography]
\setuppublications[alternative=num]

%---- 其它一些零碎设置 ----
\setupinterlinespace[big]
\setupwhitespace[big]
%\setupindenting[always,first,2em]

\setupfloats[indentnext=yes] 
\setupcaptions[style=\tfx, headstyle=\normal]

\definesymbol[1][{\color[darkgray]{\dag}}]
\setupitemize[each][packed,serried,inmargin][symbol=1,margin=2em]

\setupfootnotes[way=bychapter]

\setupinmargin[left,right][style=\tfx]

\definedescription[definition]
        [location=top,hang=20,width=broad,indenting=always,style=\ss,headstyle=\bf]

\def\mycite#1{\high{\cite[#1]}}

%% 阴影盒

\startuniqueMPgraphic{shade box}
    path p;
    u := 1cm; w := \overlaywidth; h := \overlayheight;
    roundcorner := 8pt; offset := 12pt;
    
    color shade;
    shade := (.6,.6,.6);

    for i = 0 step .02 until 1:
        fill unitsquare xyscaled (w-i*u,h-i*u) squeezed (8pt,6pt) 
             shifted (offset+i*u/2,-offset+i*u/2)
             withcolor transparent (1,.1,shade);
    endfor;

    p := unitsquare xyscaled (w, h);
    draw p withcolor transparent (1,0,white);

    p := p shifted (offset/2, -offset/2) squeezed (8pt,6pt);
    fill p withcolor \MPcolor{darkgray};
    draw p withcolor \MPcolor{OrnamentColor};
\stopuniqueMPgraphic

\defineoverlay[shade box][\uniqueMPgraphic{shade box}]
\setupframedtexts[frame=off,background={shade box}]

\stopenvironment
